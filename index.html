<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>旋转矩阵</title>
    <style>
        :root {
            --button-size: 30px;
        }

        body {
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .container {
            display: flex;
            gap: 20px;
            width: 100%;
            justify-content: center;
        }

        .vertical {
            flex-direction: column;
        }

        .horizontal {
            flex-direction: row;
        }

        table {
            border-collapse: collapse;
            background: white;
        }

        td {
            width: 40px;
            height: 40px;
            border: 1px solid #ccc;
            position: relative;
            text-align: center;
        }

        .button-container {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        button {
            padding: 8px 16px;
            cursor: pointer;
        }

        .red {
            background-color: #ff4444;
        }

        .blue {
            background-color: #4444ff;
        }

        .dot::after {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            width: 10px;
            height: 10px;
            background: black;
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }

        @media (orientation: portrait) {
            .container {
                flex-direction: column;
		align-items: center;
            }
        }

        @media (orientation: landscape) {
            .container {
                flex-direction: row;
            }
        }

        .order {
            position: absolute;
            top: 2px;
            left: 2px;
            font-size: 12px;
        }
        .count {
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 12px;
        }
        .clicked.red {
            background-color: #ff8888 !important;
        }
        .clicked.blue {
            background-color: #8888ff !important;
        }

        /* 新增规则弹窗样式 */
        .rules-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .rules-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            max-width: 80%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .rules-title {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 15px;
        }

        .rules-text {
            font-size: 16px;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="operationPanel"></div>
        <div id="targetPanel"></div>
    </div>
    <div class="button-container" id="buttonContainer"></div>

    <!-- 添加规则弹窗 -->
    <div class="rules-overlay" id="rulesOverlay">
        <div class="rules-content">
            <div class="rules-title">规则</div>
            <div class="rules-text">
                <p>1.请通过点击红色或者蓝色按钮改变黑色圆点的位置，让操作盘面和目标盘面的黑点位置一致。</p>
                <p>2.每一个按钮最多点击1次。</p>
                <p>3.每个按钮可控制以它为中心周围3 * 3范围内所有黑点的移动。移动时将该范围看成一个矩阵作相应方向的旋转。</p>
                <p>4.红色按钮会顺时针旋转矩阵90°，蓝色按钮会逆时针旋转矩阵90°。</p>
            </div>
        </div>
    </div>

<script>
    const GRID_SIZE = 7;
    const TOTAL_BUTTONS = 14;
    const RED_BUTTONS = 7;
    const BLUE_BUTTONS = 7;
    const DOTS = 14;

    let operationHistory = [];
    let solutionSteps = [];
    let initialDots = [];

    function createGrid(isTarget = false) {
        const table = document.createElement('table');
        for (let i = 0; i < GRID_SIZE; i++) {
            const tr = document.createElement('tr');
            for (let j = 0; j < GRID_SIZE; j++) {
                const td = document.createElement('td');
                td.dataset.x = i;
                td.dataset.y = j;
                if (!isTarget) {
                    td.addEventListener('click', handleButtonClick);
                }
                tr.appendChild(td);
            }
            table.appendChild(tr);
        }
        return table;
    }

    function generateRandomPositions(count, centerOnly = false) {
        const positions = [];
        while (positions.length < count) {
            const x = centerOnly ? 
                Math.floor(Math.random() * 5) + 1 : 
                Math.floor(Math.random() * 7);
            const y = centerOnly ? 
                Math.floor(Math.random() * 5) + 1 : 
                Math.floor(Math.random() * 7);
            const pos = `${x},${y}`;
            if (!positions.includes(pos)) positions.push(pos);
        }
        return positions;
    }

    function initOperationPanel() {
        const panel = document.getElementById('operationPanel');
        panel.innerHTML = '';
        const table = createGrid();

        // 生成所有中心区域的候选位置（5x5=25个）
        const allCenterPositions = [];
        for (let x = 1; x <= 5; x++) {
            for (let y = 1; y <= 5; y++) {
                allCenterPositions.push(`${x},${y}`);
            }
        }

        // 随机打乱所有中心位置
        for (let i = allCenterPositions.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [allCenterPositions[i], allCenterPositions[j]] = [allCenterPositions[j], allCenterPositions[i]];
        }

        // 确保总共选取14个不重复的位置
        const selectedPositions = allCenterPositions.slice(0, 14);

        // 分配前7个给红色，后7个给蓝色
        const redPositions = selectedPositions.slice(0, 7);
        const bluePositions = selectedPositions.slice(7, 14);

        // 应用红色按钮
        redPositions.forEach(pos => {
            const [x, y] = pos.split(',').map(Number);
            table.rows[x].cells[y].classList.add('red');
        });

        // 应用蓝色按钮
        bluePositions.forEach(pos => {
            const [x, y] = pos.split(',').map(Number);
            table.rows[x].cells[y].classList.add('blue');
        });

        // 生成黑点（保持原逻辑）
        const dotPositions = generateRandomPositions(DOTS);
        initialDots = dotPositions;
        dotPositions.forEach(pos => {
            const [x, y] = pos.split(',').map(Number);
            table.rows[x].cells[y].classList.add('dot');
        });

        panel.appendChild(table);
    }

    function rotateGrid(x, y, color) {
        const table = document.getElementById('operationPanel').querySelector('table');
        const matrix = [];
        
        // 收集3x3区域状态
        for (let i = x-1; i <= x+1; i++) {
            const row = [];
            for (let j = y-1; j <= y+1; j++) {
                if (i >= 0 && i < GRID_SIZE && j >= 0 && j < GRID_SIZE) {
                    row.push(table.rows[i].cells[j].classList.contains('dot'));
                } else {
                    row.push(false);
                }
            }
            matrix.push(row);
        }

        // 执行旋转
        const rotated = color === 'red' ? rotateClockwise(matrix) : rotateCounterClockwise(matrix);

        // 应用旋转后的状态
        for (let i = 0; i < 3; i++) {
            for (let j = 0; j < 3; j++) {
                const nx = x - 1 + i;
                const ny = y - 1 + j;
                if (nx >= 0 && nx < GRID_SIZE && ny >= 0 && ny < GRID_SIZE) {
                    const td = table.rows[nx].cells[ny];
                    rotated[i][j] ? td.classList.add('dot') : td.classList.remove('dot');
                }
            }
        }
    }

    function rotateClockwise(matrix) {
        return matrix[0].map((_, i) => 
            matrix.map(row => row[i]).reverse()
        );
    }

    function rotateCounterClockwise(matrix) {
        return matrix[0].map((_, i) => 
            matrix.map(row => row[row.length-1-i])
        );
    }

    function handleButtonClick(e) {
        const td = e.target;
        if ((!td.classList.contains('red') && !td.classList.contains('blue')) || 
            td.classList.contains('clicked')) return;

        td.classList.add('clicked');
        const x = parseInt(td.dataset.x);
        const y = parseInt(td.dataset.y);
        const color = td.classList.contains('red') ? 'red' : 'blue';
        
        rotateGrid(x, y, color);
        operationHistory.push({x, y, color});
    }

    function generateTargetPanel() {
        // 获取所有按钮
        const buttons = [];
        document.querySelectorAll('#operationPanel td.red, #operationPanel td.blue').forEach(td => {
            buttons.push({
                x: parseInt(td.dataset.x),
                y: parseInt(td.dataset.y),
                color: td.classList.contains('red') ? 'red' : 'blue'
            });
        });

        // 打乱顺序
        const shuffled = [...buttons];
        for (let i = shuffled.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
        }

        // 生成solutionSteps（包含所有按钮）
        solutionSteps = shuffled.map((btn, index) => ({
            ...btn,
            order: index + 1,
            count: Math.random() > 0.5 ? 1 : 0
        }));

        // 应用有效操作到初始状态
        let currentDots = initialDots.map(p => p.split(',').map(Number));
        solutionSteps.forEach(step => {
            if (step.count === 1) {
                currentDots = applyRotation(currentDots, step.x, step.y, step.color);
            }
        });

        // 更新目标盘面
        const targetTable = document.querySelector('#targetPanel table');
        targetTable.querySelectorAll('.dot').forEach(d => d.classList.remove('dot'));
        currentDots.forEach(([x, y]) => {
            targetTable.rows[x].cells[y].classList.add('dot');
        });
    }

    function applyRotation(dots, x, y, color) {
        // 创建3x3矩阵
        const matrix = Array(3).fill().map(() => Array(3).fill(false));
        for (let dx = -1; dx <= 1; dx++) {
            for (let dy = -1; dy <= 1; dy++) {
                const nx = x + dx;
                const ny = y + dy;
                if (nx >=0 && nx < GRID_SIZE && ny >=0 && ny < GRID_SIZE) {
                    matrix[dx+1][dy+1] = dots.some(([px, py]) => px === nx && py === ny);
                }
            }
        }

        // 旋转矩阵
        const rotated = color === 'red' ? rotateClockwise(matrix) : rotateCounterClockwise(matrix);
        
        // 生成新的点集合
        const newDots = dots.filter(([px, py]) => 
            Math.abs(px - x) > 1 || Math.abs(py - y) > 1
        );

        for (let i = 0; i < 3; i++) {
            for (let j = 0; j < 3; j++) {
                const nx = x - 1 + i;
                const ny = y - 1 + j;
                if (rotated[i][j] && nx >=0 && nx < GRID_SIZE && ny >=0 && ny < GRID_SIZE) {
                    newDots.push([nx, ny]);
                }
            }
        }
        return newDots;
    }

    function initTargetPanel() {
        const panel = document.getElementById('targetPanel');
        panel.innerHTML = '';
        const table = createGrid(true);
        
        // 复制操作面板的红蓝按钮到目标面板
        const operationTable = document.querySelector('#operationPanel table');
        for (let i = 0; i < GRID_SIZE; i++) {
            for (let j = 0; j < GRID_SIZE; j++) {
                const opTd = operationTable.rows[i].cells[j];
                const targetTd = table.rows[i].cells[j];
                targetTd.className = opTd.className; // 复制所有类
            }
        }

        panel.appendChild(table);
    }

function initButtons() {
    const container = document.getElementById('buttonContainer');
    container.innerHTML = `
        <button id="showRules">规则</button>
        <button id="undo">撤回</button>
        <button id="submit">提交答案</button>
    `;  // 移除showAnswer按钮

    // 规则按钮事件
    document.getElementById('showRules').addEventListener('click', () => {
        document.getElementById('rulesOverlay').style.display = 'flex';
    });

    // 关闭规则弹窗
    document.getElementById('rulesOverlay').addEventListener('click', (e) => {
        if (e.target === document.getElementById('rulesOverlay')) {
            document.getElementById('rulesOverlay').style.display = 'none';
        }
    });

    // 撤回按钮事件
    document.getElementById('undo').addEventListener('click', () => {
        if (operationHistory.length === 0) return;
        const last = operationHistory.pop();
        const td = document.querySelector(`#operationPanel td[data-x="${last.x}"][data-y="${last.y}"]`);
        td.classList.remove('clicked');
        rotateGrid(last.x, last.y, last.color === 'red' ? 'blue' : 'red');
    });

    // 提交按钮事件
    document.getElementById('submit').addEventListener('click', () => {
        const getDots = panel => 
            [...panel.querySelectorAll('.dot')].map(d => [
                parseInt(d.parentElement.rowIndex),
                parseInt(d.cellIndex)
            ]).sort();
        
        const opDots = getDots(document.getElementById('operationPanel'));
        const targetDots = getDots(document.getElementById('targetPanel'));
        
        alert(JSON.stringify(opDots) === JSON.stringify(targetDots) 
            ? '成功！' : '失败！');
    });
}

    // 初始化游戏
    initOperationPanel();
    initTargetPanel();
    generateTargetPanel();
    initButtons();
</script>

</body>
</html>
